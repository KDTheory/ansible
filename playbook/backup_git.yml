---
- name: Pousser les modifications du dossier kevin/config vers le dépôt Git
  hosts: all
  become: yes
  vars:
    repo_path: "/home/kevin/config"
    log_file: "/home/kevin/config/script/log/backup.log"
    max_log_size: 1

  tasks:
    - name: Vérifier que Git est installé
      command: git --version
      register: git_version
      failed_when: git_version.rc != 0
      changed_when: false

    - name: Créer le répertoire de log si nécessaire
      file:
        path: "{{ log_file | dirname }}"
        state: directory

    - name: Vérifier la taille du fichier de log et effectuer une rotation si nécessaire
      command: >
        if [ -e "{{ log_file }}" ]; then
          if [ $(du -m "{{ log_file }}" | awk '{print $1}') -gt {{ max_log_size }} ]; then
            mv "{{ log_file }}" "{{ log_file }}.1" &&
            rm -f "{{ log_file }}.2" &&
            mv "{{ log_file }}.1" "{{ log_file }}.2";
          fi;
        fi
      ignore_errors: yes

    - name: Configurer le fichier de log pour la sortie standard et les erreurs
      command: >
        exec >> "{{ log_file }}" 2>&1
      ignore_errors: yes

    - name: Afficher un message de début de sauvegarde
      debug:
        msg: "-----------------------------/!\\ Backup commencé le {{ ansible_date_time.iso8601 }} /!\\-----------------------------"
      register: log_start_message

    - name: Changer de répertoire vers le répertoire Git
      command: cd "{{ repo_path }}"
      args:
        chdir: "{{ repo_path }}"
      ignore_errors: yes

    - name: Ajouter tous les fichiers modifiés à l'index Git
      command: git add .
      args:
        chdir: "{{ repo_path }}"
      ignore_errors: yes

    - name: Créer un message de commit avec la date et l'heure actuelles
      command: git commit -m "Backup for {{ ansible_date_time.iso8601 }}"
      args:
        chdir: "{{ repo_path }}"
      ignore_errors: yes

    - name: Effectuer git push
      command: git push
      args:
        chdir: "{{ repo_path }}"
      ignore_errors: yes

    - name: Afficher un message de succès
      debug:
        msg: "-----------------------------/!\\ Backup effectué le {{ ansible_date_time.iso8601 }} /!\\-----------------------------"
      register: log_success_message
